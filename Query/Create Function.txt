-- ========================================================
-- üìä C√ÅC FUNCTION TH·ªêNG K√ä D√ÇN C∆Ø / L√ÄM VI·ªÜC
-- (D·ª±a tr√™n c·∫•u tr√∫c b·∫£ng DiaChi v√† DiaChiNguoiDung hi·ªán t·∫°i)
-- ========================================================

-- 1Ô∏è Th·ªëng k√™ s·ªë ng∆∞·ªùi th∆∞·ªùng tr√∫ ·ªü m·ªôt ph∆∞·ªùng/x√£
CREATE OR REPLACE FUNCTION thong_ke_thuong_tru_phuong(ten_xa_phuong VARCHAR)
RETURNS INT AS $$
DECLARE
    so_luong INT;
BEGIN
    SELECT COUNT(*) INTO so_luong
    FROM DiaChiNguoiDung dcnd
    JOIN DiaChi dc ON dcnd.MaDiaChi = dc.MaDiaChi
    WHERE dcnd.LoaiDiaChi = 'CuTru'
      AND dc.XaPhuong = ten_xa_phuong
      AND dcnd.ThoiDiemKetThuc IS NULL;
    RETURN so_luong;
END;
$$ LANGUAGE plpgsql;


-- 2Ô∏è Th·ªëng k√™ s·ªë ng∆∞·ªùi th∆∞·ªùng tr√∫ ·ªü m·ªôt t·ªânh
CREATE OR REPLACE FUNCTION thong_ke_thuong_tru_tinh(ten_tinh VARCHAR)
RETURNS INT AS $$
DECLARE
    so_luong INT;
BEGIN
    SELECT COUNT(*) INTO so_luong
    FROM DiaChiNguoiDung dcnd
    JOIN DiaChi dc ON dcnd.MaDiaChi = dc.MaDiaChi
    WHERE dcnd.LoaiDiaChi = 'CuTru'
      AND dc.Tinh = ten_tinh
      AND dcnd.ThoiDiemKetThuc IS NULL;
    RETURN so_luong;
END;
$$ LANGUAGE plpgsql;


-- 3Ô∏è Th·ªëng k√™ s·ªë ng∆∞·ªùi t·∫°m tr√∫ ·ªü m·ªôt ph∆∞·ªùng/x√£
CREATE OR REPLACE FUNCTION thong_ke_tam_tru_phuong(ten_xa_phuong VARCHAR)
RETURNS INT AS $$
DECLARE
    so_luong INT;
BEGIN
    SELECT COUNT(*) INTO so_luong
    FROM DiaChiNguoiDung dcnd
    JOIN DiaChi dc ON dcnd.MaDiaChi = dc.MaDiaChi
    WHERE dcnd.LoaiDiaChi = 'TamTru'
      AND dc.XaPhuong = ten_xa_phuong
      AND dcnd.ThoiDiemKetThuc IS NULL;
    RETURN so_luong;
END;
$$ LANGUAGE plpgsql;


-- 4Ô∏è Th·ªëng k√™ s·ªë ng∆∞·ªùi t·∫°m tr√∫ ·ªü m·ªôt t·ªânh
CREATE OR REPLACE FUNCTION thong_ke_tam_tru_tinh(ten_tinh VARCHAR)
RETURNS INT AS $$
DECLARE
    so_luong INT;
BEGIN
    SELECT COUNT(*) INTO so_luong
    FROM DiaChiNguoiDung dcnd
    JOIN DiaChi dc ON dcnd.MaDiaChi = dc.MaDiaChi
    WHERE dcnd.LoaiDiaChi = 'TamTru'
      AND dc.Tinh = ten_tinh
      AND dcnd.ThoiDiemKetThuc IS NULL;
    RETURN so_luong;
END;
$$ LANGUAGE plpgsql;


-- 5Ô∏è Th·ªëng k√™ s·ªë ng∆∞·ªùi l√†m vi·ªác ·ªü m·ªôt ph∆∞·ªùng/x√£
CREATE OR REPLACE FUNCTION thong_ke_lam_viec_phuong(ten_xa_phuong VARCHAR)
RETURNS INT AS $$
DECLARE
    so_luong INT;
BEGIN
    SELECT COUNT(*) INTO so_luong
    FROM DiaChiNguoiDung dcnd
    JOIN DiaChi dc ON dcnd.MaDiaChi = dc.MaDiaChi
    WHERE dcnd.LoaiDiaChi = 'NoiLamViec'
      AND dc.XaPhuong = ten_xa_phuong
      AND dcnd.ThoiDiemKetThuc IS NULL;
    RETURN so_luong;
END;
$$ LANGUAGE plpgsql;


-- 6Ô∏è Th·ªëng k√™ s·ªë ng∆∞·ªùi l√†m vi·ªác ·ªü m·ªôt t·ªânh
CREATE OR REPLACE FUNCTION thong_ke_lam_viec_tinh(ten_tinh VARCHAR)
RETURNS INT AS $$
DECLARE
    so_luong INT;
BEGIN
    SELECT COUNT(*) INTO so_luong
    FROM DiaChiNguoiDung dcnd
    JOIN DiaChi dc ON dcnd.MaDiaChi = dc.MaDiaChi
    WHERE dcnd.LoaiDiaChi = 'NoiLamViec'
      AND dc.Tinh = ten_tinh
      AND dcnd.ThoiDiemKetThuc IS NULL;
    RETURN so_luong;
END;
$$ LANGUAGE plpgsql;


-- 7Ô∏è Th·ªëng k√™ t·ªïng h·ª£p (theo t·ªânh) - tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß lo·∫°i ƒë·ªãa ch·ªâ
CREATE OR REPLACE FUNCTION thong_ke_tong_hop_tinh(ten_tinh VARCHAR)
RETURNS TABLE (
    Tinh VARCHAR,
    SoCuTru INT,
    SoTamTru INT,
    SoNoiLamViec INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        ten_tinh AS Tinh,
        (SELECT COUNT(*) FROM DiaChiNguoiDung dcnd JOIN DiaChi dc ON dc.MaDiaChi = dcnd.MaDiaChi
         WHERE dc.Tinh = ten_tinh AND dcnd.LoaiDiaChi = 'CuTru' AND dcnd.ThoiDiemKetThuc IS NULL),
        (SELECT COUNT(*) FROM DiaChiNguoiDung dcnd JOIN DiaChi dc ON dc.MaDiaChi = dcnd.MaDiaChi
         WHERE dc.Tinh = ten_tinh AND dcnd.LoaiDiaChi = 'TamTru' AND dcnd.ThoiDiemKetThuc IS NULL),
        (SELECT COUNT(*) FROM DiaChiNguoiDung dcnd JOIN DiaChi dc ON dc.MaDiaChi = dcnd.MaDiaChi
         WHERE dc.Tinh = ten_tinh AND dcnd.LoaiDiaChi = 'NoiLamViec' AND dcnd.ThoiDiemKetThuc IS NULL);
END;
$$ LANGUAGE plpgsql;
